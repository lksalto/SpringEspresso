<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Detalhes da Sessão</title>
    <link rel="stylesheet" th:href="@{/css/main.css}"/>
    <style>
        .details-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px 20px;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .details-grid dt {
            font-weight: bold;
            text-align: right;
        }
        .details-grid dd {
            margin: 0;
        }
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
            color: white;
            font-size: 0.8em;
            text-transform: uppercase;
        }
        .status-criado { background-color: #007bff; }
        .status-em_execucao { background-color: #ffc107; color: #212529; }
        .status-finalizado { background-color: #28a745; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="wrapper">
    <h1>Detalhes da Sessão de Teste</h1>

    <div th:if="${success}" class="message-box success" th:text="${success}"></div>
    <div th:if="${fail}" class="message-box error" th:text="${fail}"></div>

    <div th:if="${sessao != null}">
        <dl class="details-grid">
            <dt>Projeto:</dt>
            <dd th:text="${sessao.projeto.nome}"></dd>

            <dt>Estratégia:</dt>
            <dd th:text="${sessao.estrategia.nome}"></dd>

            <dt>Descrição:</dt>
            <dd th:text="${sessao.descricao}"></dd>

            <dt>Duração:</dt>
            <dd th:text="${sessao.duracao != null ? sessao.duracao.toMinutes() + ' minutos' : 'N/A'}"></dd>

            <dt>Status:</dt>
            <dd>
                <span th:text="${sessao.status.getDescricao()}"
                      th:classappend="'status-' + ${#strings.toLowerCase(sessao.status.name())}"
                      class="status-badge">
                </span>
            </dd>

            <dt>Tester:</dt>
            <!-- Correção: Verifica se o tester não é nulo antes de acessar o nome -->
            <dd th:text="${sessao.tester != null ? sessao.tester.nome : 'Não atribuído'}"></dd>
        </dl>

        <h2>Bugs Reportados</h2>
        <div th:if="${#lists.isEmpty(sessao.bugs)}">
            <p>Nenhum bug foi reportado para esta sessão ainda.</p>
        </div>
        <table class="table table-striped" th:unless="${#lists.isEmpty(sessao.bugs)}">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Descrição</th>
                    <th>Data de Registro</th>
                    <th>Imagem</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="bug : ${sessao.bugs}">
                    <td th:text="${bug.id}"></td>
                    <td th:text="${bug.descricao}"></td>
                    <td th:text="${#temporals.format(bug.dataRegistro, 'dd/MM/yyyy HH:mm')}"></td>
                    <td>
                        <a th:if="${bug.caminhoImagem != null}" th:href="@{${'/uploads/' + bug.caminhoImagem}}" target="_blank">Ver Imagem</a>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <p>
            <a th:href="@{/bugs/cadastro(idSessao=${sessao.id})}" class="button button-primary">Reportar Novo Bug</a>
        </p>

    </div>

    <p>
        <a th:if="${sessao != null}" th:href="@{/projetos/{pid}/estrategias/{eid}/sessoes(pid=${sessao.projeto.id}, eid=${sessao.estrategia.id})}" class="button button-secondary">Voltar para a Lista de Sessões</a>
        <a th:if="${sessao == null}" th:href="@{/home}" class="button button-secondary">Voltar ao Início</a>
    </p>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>